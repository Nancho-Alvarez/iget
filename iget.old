#! /usr/bin/perl

use strict;
use warnings;

my $animated=0;
if ($ARGV[0] eq "-a") {
	$animated=1;
	shift @ARGV;
}
my $terminos=join('+',@ARGV);
my $auxfile = "boriget.html";

my $url="https://www.google.es/search?\\\&tbm=isch\\\&tbs=isz:lt,islt:vga\\\&q=$terminos";
if ($animated) {
	$url=$url . "\\\&tbs=itp:animated";
}
#if ($animated) {
#	my $url="https://www.google.es/search?\\\&tbm=isch\\\&tbs=isz:lt,islt:vga\\\&tbs=itp:animated\\\&q=$terminos";
#}
#else {
#	my $url="https://www.google.es/search?\\\&tbm=isch\\\&tbs=isz:lt,islt:vga\\\&q=$terminos";
#}
my $ua = "--user-agent=\"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.75 Safari/537.36\""; 
system("wget $url -O $auxfile $ua\n");

open(my $fh, $auxfile)
  or die "Could not open file '$auxfile' $!";

my @total= ();
while (my $row = <$fh>) {
#   my @lista = $row =~ /imgurl=([^&]*)&/g;
    my @lista = $row =~ /"(https*:\/\/[^"]*?\.(?:jpg|jpeg|JPG|JPEG|Jpg|Jpeg|gif|GIF|Gif|png|PNG|Png))"/g;
	push(@total, @lista);
}
my $i = 1000;
foreach $a (@total) {
	my $out = $terminos . $i;
	if ($animated) { $out = $out . ".gif"; }
	system("wget --tries=1 --timeout=4 $a -O $out\n");
	$i++;
}
system("rm $auxfile");
