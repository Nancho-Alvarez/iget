#! /usr/bin/perl

use strict;
use warnings;

my $animated=0;
if ($ARGV[0] eq "-a") {
	$animated=1;
	shift @ARGV;
}

my $buscador="google";
if (substr($ARGV[0],0,1) eq "-") {
	$buscador="yahoo" if ($ARGV[0] eq "-y");
	$buscador="bing" if ($ARGV[0] eq "-b");
	$buscador="google" if ($ARGV[0] eq "-g");
	shift @ARGV;
}

my @chars=("a".."z");
my $auxfile; # random string
$auxfile .= $chars[rand @chars] for 1..12;
my $terminos=join('+',@ARGV);

my $ua="\"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.167 Safari/537.36\"";
my $url="https://www.google.es/search?\\\&tbm=isch\\\&tbs=isz:lt,islt:vga\\\&q=$terminos";
my $animated_option="\\\&tbs=itp:animated";
my $cookies="";
my $initial_number=1000;
my $regex='"ou":"([^"]*?)"';
if ($buscador eq "yahoo") {
	$url="https://images.search.yahoo.com/search/images?\\\&q=$terminos";
	$animated_option="\\\&imgty=gif";
	$cookies="--header=\"Cookie: sB=vm=p\"";
	$initial_number=2000;
	$regex='"iurl":"([^"]*?)"';
}
if ($buscador eq "bing") {
	$ua="";
	$url="https://www.bing.com/images/search?q=$terminos\\\&first=1";
	$animated_option="\\\&qft=+filterui:photo-animatedgif";
	$cookies="--header=\"Cookie: SRCHHPGUSR=ADLT=OFF; _SS=SID=0\"";
	$initial_number=3000;
	$regex='blank" href="([^";=]*?[^/])" h=';
}


if ($animated) {
	$url=$url . $animated_option;
}
system("wget $cookies $url -O $auxfile --user-agent=$ua\n");
open(my $fh, $auxfile)
  or die "Could not open file '$auxfile' $!";

my @total= ();
while (my $row = <$fh>) {
	my @lista = $row =~ /$regex/g;
	
	push(@total, @lista);
}
close($fh) or die "Could not close file '$auxfile' $!";

my $i = $initial_number;
foreach $a (@total) {
	$a =~ s/\(/\\\(/g; # escape parentheses
	$a =~ s/\)/\\\)/g;
	my $out = $terminos . $i;
	if ($animated) { $out = $out . ".gif"; }
	system("wget --tries=1 --timeout=4 $a -O $out\n");
	$i++;
}
system("rm $auxfile");
